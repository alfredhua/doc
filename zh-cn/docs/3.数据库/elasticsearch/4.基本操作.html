<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="4.基本操作" />
	<meta name="description" content="4.基本操作" />
	<!-- 网页标签标题 -->
	<title>4.基本操作</title>
	<link rel="shortcut icon" href="/img/docsite.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a class="logo" href="/zh-cn/index.html"><span class="logo-normal">码农阿华| <span class="logo-desc">玩玩技术，说说产品</span></span></a><div class="search search-normal"><span class="icon-search"></span></div><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/docs/begin.html" target="_self">文档</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/blog/index.html" target="_self">博客</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>设计模式</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>设计原则<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/2.开闭原则.html" target="_self">开闭原则</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/3.接口隔离原则.html" target="_self">接口隔离原则</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>JAVA</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>目录<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/dir/demo3.html" target="_self">示例3</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h2 id="%E6%96%B0%E5%BB%BA%E5%92%8C%E5%88%A0%E9%99%A4index">新建和删除Index <a class="header-anchor" href="#%E6%96%B0%E5%BB%BA%E5%92%8C%E5%88%A0%E9%99%A4index">#</a></h2>
<p>新建 Index，可以直接向 Elastic 服务器发出 PUT 请求。下面的例子是新建一个名叫weather的 Index。</p>
<pre><code class="language-shell">curl -X PUT 'localhost:9200/weather'

</code></pre>
<p>服务器返回一个 JSON 对象，里面的acknowledged字段表示操作成功。</p>
<pre><code class="language-json">{
  <span class="hljs-attr">"acknowledged"</span>:<span class="hljs-literal">true</span>,
  <span class="hljs-attr">"shards_acknowledged"</span>:<span class="hljs-literal">true</span>
}
</code></pre>
<p>然后，我们发出 DELETE 请求，删除这个 Index。</p>
<pre><code class="language-shell">curl -X DELETE 'localhost:9200/weather'
</code></pre>
<h2 id="%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E8%AE%BE%E7%BD%AE">中文分词设置 <a class="header-anchor" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E8%AE%BE%E7%BD%AE">#</a></h2>
<pre><code class="language-shell">
elasticsearch plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.8.7/elasticsearch-analysis-ik-6.8.7.zip
</code></pre>
<h2 id="%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C">数据操作 <a class="header-anchor" href="#%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C">#</a></h2>
<h3 id="%E6%96%B0%E5%A2%9E%E8%AE%B0%E5%BD%95">新增记录 <a class="header-anchor" href="#%E6%96%B0%E5%A2%9E%E8%AE%B0%E5%BD%95">#</a></h3>
<p>向指定的 /Index/Type 发送 PUT 请求，就可以在 Index 里面新增一条记录。比如，向/accounts/person发送请求，就可以新增一条人员记录。</p>
<pre><code class="language-shell">
curl -H "Content-Type: application/json" -X PUT 'localhost:9200/accounts/person/1' -d '
{
  "user": "张三",
  "title": "工程师",
  "desc": "数据库管理"
}'

</code></pre>
<p>服务器返回的 JSON 对象，会给出 Index、Type、Id、Version 等信息。</p>
<pre><code class="language-shell">{
  "_index":"accounts",
  "_type":"person",
  "_id":"1",
  "_version":1,
  "result":"created",
  "_shards":{"total":2,"successful":1,"failed":0},
  "created":true
}

</code></pre>
<h2 id="%E6%9F%A5%E7%9C%8B%E8%AE%B0%E5%BD%95">查看记录 <a class="header-anchor" href="#%E6%9F%A5%E7%9C%8B%E8%AE%B0%E5%BD%95">#</a></h2>
<pre><code class="language-shell">
curl 'localhost:9200/accounts/person/1?pretty=true'

</code></pre>
<p>上面代码请求查看/accounts/person/1这条记录，URL 的参数pretty=true表示以易读的格式返回。</p>
<p>返回的数据中，found字段表示查询成功，_source字段返回原始记录。</p>
<pre><code class="language-json">
{
  <span class="hljs-attr">"_index"</span> : <span class="hljs-string">"accounts"</span>,
  <span class="hljs-attr">"_type"</span> : <span class="hljs-string">"person"</span>,
  <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"1"</span>,
  <span class="hljs-attr">"_version"</span> : <span class="hljs-number">1</span>,
  <span class="hljs-attr">"found"</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"_source"</span> : {
    <span class="hljs-attr">"user"</span> : <span class="hljs-string">"张三"</span>,
    <span class="hljs-attr">"title"</span> : <span class="hljs-string">"工程师"</span>,
    <span class="hljs-attr">"desc"</span> : <span class="hljs-string">"数据库管理"</span>
  }
}

</code></pre>
<h2 id="%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95">删除记录 <a class="header-anchor" href="#%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95">#</a></h2>
<p>删除记录就是发出 DELETE 请求。</p>
<pre><code class="language-java">curl -X DELETE <span class="hljs-string">'localhost:9200/accounts/person/1'</span>
</code></pre>
<h2 id="%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95">更新记录 <a class="header-anchor" href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95">#</a></h2>
<p>更新记录就是使用 PUT 请求，重新发送一次数据。</p>
<pre><code class="language-shell"> curl -H "Content-Type: application/json" -X PUT 'localhost:9200/accounts/person/1' -d '
{
    "user" : "张三",
    "title" : "工程师",
    "desc" : "数据库管理，软件开发"
}'

</code></pre>
<h2 id="%E8%BF%94%E5%9B%9E%E6%89%80%E6%9C%89%E8%AE%B0%E5%BD%95">返回所有记录 <a class="header-anchor" href="#%E8%BF%94%E5%9B%9E%E6%89%80%E6%9C%89%E8%AE%B0%E5%BD%95">#</a></h2>
<p>使用 GET 方法，直接请求/Index/Type/_search，就会返回所有记录。</p>
<pre><code class="language-shell">curl 'localhost:9200/accounts/person/_search'

{
  "took":2,
  "timed_out":false,
  "_shards":{"total":5,"successful":5,"failed":0},
  "hits":{
    "total":2,
    "max_score":1.0,
    "hits":[
      {
        "_index":"accounts",
        "_type":"person",
        "_id":"AV3qGfrC6jMbsbXb6k1p",
        "_score":1.0,
        "_source": {
          "user": "李四",
          "title": "工程师",
          "desc": "系统管理"
        }
      },
      {
        "_index":"accounts",
        "_type":"person",
        "_id":"1",
        "_score":1.0,
        "_source": {
          "user" : "张三",
          "title" : "工程师",
          "desc" : "数据库管理，软件开发"
        }
      }
    ]
  }
}

</code></pre>
<h2 id="%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2">全文搜索 <a class="header-anchor" href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2">#</a></h2>
<h3 id="match">match <a class="header-anchor" href="#match">#</a></h3>
<pre><code class="language-shell">
curl -H "Content-Type: application/json"  'localhost:9200/accounts/person/_search'  -d '
{
  "query" : { "match" : { "desc" : "软件" }}
}'

</code></pre>
<p>Elastic 默认一次返回10条结果，可以通过size字段改变这个设置。</p>
<pre><code class="language-shell"><span class="hljs-meta">$</span><span class="bash"> curl -H <span class="hljs-string">"Content-Type: application/json"</span> <span class="hljs-string">'localhost:9200/accounts/person/_search'</span>  -d <span class="hljs-string">'</span></span>
{
  "query" : { "match" : { "desc" : "管理" }},
  "size": 1
}'
</code></pre>
<p>上面代码指定，每次只返回一条结果。</p>
<p>还可以通过from字段，指定位移。</p>
<pre><code class="language-shell"><span class="hljs-meta">$</span><span class="bash"> curl -H <span class="hljs-string">"Content-Type: application/json"</span> <span class="hljs-string">'localhost:9200/accounts/person/_search'</span>  -d <span class="hljs-string">'</span></span>
{
  "query" : { "match" : { "desc" : "管理" }},
  "from": 1,
  "size": 1
}'
</code></pre>
<p>上面代码指定，从位置1开始（默认是从位置0开始），只返回一条结果。</p>
<h3 id="match_phrase">match_phrase <a class="header-anchor" href="#match_phrase">#</a></h3>
<ul>
<li>可以搜索分词相邻的结果，eg 根据新疆苹果可以搜到香甜新疆苹果而搜不到新疆香甜苹果</li>
<li>可以使用slop指定两个匹配的token位置距离的最大值。</li>
<li>可以使用analyzer指定分词器，覆盖mapping中设置的search_analyzer</li>
</ul>
<p>冬天暖心羽绒服 冬天超级暖心羽绒服 花花公子暖心羽绒服</p>
<p>我们在设置了slop后允许超级和羽绒服这两个分词后的token距离最大值为2，可以搜索到如下数据了。因为冬天超级暖心羽绒服分词结果为冬天，超级,暖，心，羽绒服，超级与羽绒服距离正好为2，所以能匹配到。</p>
<pre><code class="language-json">{
  <span class="hljs-attr">"query"</span>: {
    <span class="hljs-attr">"match_phrase"</span>: {
      <span class="hljs-attr">"name"</span>: {
        <span class="hljs-attr">"query"</span>: <span class="hljs-string">"超级羽绒服"</span>,
        <span class="hljs-attr">"analyzer"</span>: <span class="hljs-string">"ik_smart"</span>,
        <span class="hljs-attr">"slop"</span>: <span class="hljs-number">2</span>
      }
    }
  }
}

</code></pre>
<h2 id="%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97">逻辑运算 <a class="header-anchor" href="#%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97">#</a></h2>
<p>如果有多个搜索关键字， Elastic 认为它们是or关系。</p>
<pre><code class="language-shell">curl 'localhost:9200/accounts/person/_search'  -d '
{
  "query" : { "match" : { "desc" : "软件 系统" }}
}'

</code></pre>
<p>上面代码搜索的是软件 or 系统。</p>
<p>如果要执行多个关键词的and搜索，必须使用布尔查询。</p>
<h3 id="bool%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2%23">bool组合查询# <a class="header-anchor" href="#bool%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2%23">#</a></h3>
<p>bool查询可以组合多种叶子查询，包含如下：</p>
<ul>
<li>must：出现于匹配查询当中，有助于匹配度(_score)的计算</li>
<li>filter：必须满足才能出现，属于过滤，不会影响分值的计算，但是会过滤掉不符合的数据</li>
<li>should：该条件下的内容是应该满足的内容，如果符合会增加分值，不符合降低分值，不会不显示</li>
<li>must_not：满足的内容不会出现，与filter功能相反，属于过滤，不会影响分值的计算，但是会过滤掉不符合的数据</li>
</ul>
<pre><code class="language-json">
{
  <span class="hljs-attr">"query"</span>: {
    <span class="hljs-attr">"bool"</span>: {
      <span class="hljs-attr">"must"</span>: [
        {    
          <span class="hljs-attr">"match"</span>: {
            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"花花公子羽绒服"</span>
          }
        }
      ],
      <span class="hljs-attr">"must_not"</span>: [
        {
          <span class="hljs-attr">"term"</span>: {
            <span class="hljs-attr">"proId"</span>: <span class="hljs-number">6</span>
          }
        }
      ], 
      <span class="hljs-attr">"should"</span>: [
        {
          <span class="hljs-attr">"terms"</span>: {
            <span class="hljs-attr">"name.keyword"</span>: [<span class="hljs-string">"花花公子暖心羽绒服"</span>, <span class="hljs-string">"花花公子外套"</span>]
          }
        }
      ], 
      <span class="hljs-attr">"filter"</span>: {
        <span class="hljs-attr">"range"</span>: {
          <span class="hljs-attr">"createTime"</span>: {
            <span class="hljs-attr">"gte"</span>: <span class="hljs-string">"2019-12-12 17:56:56"</span>,
            <span class="hljs-attr">"lte"</span>: <span class="hljs-string">"2019-12-19 17:56:56"</span>,
            <span class="hljs-attr">"format"</span>: <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>
          }
        }
      }
    }
  }
}

</code></pre>
<pre><code class="language-shell">curl 'localhost:9200/accounts/person/_search'  -d '
{
  "query": {
    "bool": {
      "must": [
        { "match": { "desc": "软件" } },
        { "match": { "desc": "系统" } }
      ]
    }
  }
}'
</code></pre>
</div></section><footer class="footer-container"><div class="footer-body"><div class="cols-container"><div class="col col-12"><h3>码农阿华</h3><p>联系邮箱：alfredhua@aliyun.com</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/demo1.html" target="_self">概览</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd></dl></div></div><div class="copyright"><span>CopyRight©2019 版权所有 码农阿华 京ICP备19044364号</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>