<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="2.消息模式" />
	<meta name="description" content="2.消息模式" />
	<!-- 网页标签标题 -->
	<title>2.消息模式</title>
	<link rel="shortcut icon" href="/img/docsite.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a class="logo" href="/zh-cn/index.html"><span class="logo-normal">码农阿华| <span class="logo-desc">玩玩技术，说说产品</span></span></a><div class="search search-normal"><span class="icon-search"></span></div><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/docs/begin.html" target="_self">文档</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/blog/index.html" target="_self">博客</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>设计模式</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>设计原则<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/2.开闭原则.html" target="_self">开闭原则</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/3.接口隔离原则.html" target="_self">接口隔离原则</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>JAVA</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>目录<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/dir/demo3.html" target="_self">示例3</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h2 id="%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F">简单模式 <a class="header-anchor" href="#%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F">#</a></h2>
<p>一个生产者P发送消息到队列Q,一个消费者C接收</p>
<p><a href="https://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/blog/u=3536793445,2882105203&amp;fm=26&amp;gp=0.gif">https://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/blog/u=3536793445,2882105203&amp;fm=26&amp;gp=0.gif</a></p>
<p><img src="https://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/9e555b0d8fa144cfbb3421e3b19a018f" alt="image"></p>
<pre><code class="language-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Send</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String QUEUE_NAME = <span class="hljs-string">"hello"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"localhost"</span>);
        <span class="hljs-keyword">try</span> (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            channel.queueDeclare(QUEUE_NAME, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);
            String message = <span class="hljs-string">"Hello World!"</span>;
            channel.basicPublish(<span class="hljs-string">""</span>, QUEUE_NAME, <span class="hljs-keyword">null</span>, message.getBytes(StandardCharsets.UTF_8));
            System.out.println(<span class="hljs-string">" [x] Sent '"</span> + message + <span class="hljs-string">"'"</span>);
        }
    }
}

</code></pre>
<pre><code class="language-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recv</span> </span>{

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String QUEUE_NAME = <span class="hljs-string">"hello"</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    Connection connection = factory.newConnection();
    Channel channel = connection.createChannel();
    channel.queueDeclare(QUEUE_NAME, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);
    System.out.println(<span class="hljs-string">" [*] Waiting for messages. To exit press CTRL+C"</span>);

  }
}

</code></pre>
<h2 id="%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8Fwork-queue">工作队列模式Work Queue <a class="header-anchor" href="#%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8Fwork-queue">#</a></h2>
<p><img src="http://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/f25207b901d94d2fbbad2f3d0245aa0d" alt="image"></p>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewTask</span> </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TASK_QUEUE_NAME = <span class="hljs-string">"task_queue"</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    <span class="hljs-keyword">try</span> (Connection connection = factory.newConnection();
         Channel channel = connection.createChannel()) {
        channel.queueDeclare(TASK_QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

        String message = String.join(<span class="hljs-string">" "</span>, argv);

        channel.basicPublish(<span class="hljs-string">""</span>, TASK_QUEUE_NAME,
                MessageProperties.PERSISTENT_TEXT_PLAIN,
                message.getBytes(<span class="hljs-string">"UTF-8"</span>));
        System.out.println(<span class="hljs-string">" [x] Sent '"</span> + message + <span class="hljs-string">"'"</span>);
    }
  }
}
</code></pre>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recv</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TASK_QUEUE_NAME = <span class="hljs-string">"task_queue"</span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"localhost"</span>);
        factory.setUsername(<span class="hljs-string">"guest"</span>);
        factory.setPassword(<span class="hljs-string">"guest"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {
            String message = <span class="hljs-keyword">new</span> String(delivery.getBody(), <span class="hljs-string">"UTF-8"</span>);
            System.out.println(<span class="hljs-string">" [x] Received '"</span> + message + <span class="hljs-string">"'"</span>);
            <span class="hljs-keyword">try</span> {
                doWork(message);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            } <span class="hljs-keyword">finally</span> {
                System.out.println(<span class="hljs-string">" [x] Done"</span>);
            }
        };
        <span class="hljs-keyword">boolean</span> autoAck = <span class="hljs-keyword">true</span>; <span class="hljs-comment">// acknowledgment is covered below</span>
        channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, consumerTag -&gt; { });

    }
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doWork</span><span class="hljs-params">(String task)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">char</span> ch: task.toCharArray()) {
            <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">'.'</span>) Thread.sleep(<span class="hljs-number">1000</span>);
        }
    }
}

</code></pre>
<h2 id="%E5%8F%91%E5%B8%83%2F%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8Fpublish%2Fsubscribe">发布/订阅模式Publish/Subscribe <a class="header-anchor" href="#%E5%8F%91%E5%B8%83%2F%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8Fpublish%2Fsubscribe">#</a></h2>
<p><img src="http://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/64d071ed89c74822988c6b7554ecc4c9" alt="image"></p>
<p>功能：一个生产者发送的消息会被多个消费者获取。一个生产者、一个交换机、多个队列、多个消费者</p>
<p>生产者：可以将消息发送到队列或者是交换机。</p>
<p>消费者：只能从队列中获取消息。</p>
<p>如果消息发送到没有队列绑定的交换机上，那么消息将丢失。
交换机不能存储消息，消息存储在队列中</p>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmitLog</span> </span>{

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"logs"</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    <span class="hljs-keyword">try</span> (Connection connection = factory.newConnection();
         Channel channel = connection.createChannel()) {
        channel.exchangeDeclare(EXCHANGE_NAME, <span class="hljs-string">"fanout"</span>);

        String message = argv.length &lt; <span class="hljs-number">1</span> ? <span class="hljs-string">"info: Hello World!"</span> :
                            String.join(<span class="hljs-string">" "</span>, argv);

        channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, message.getBytes(<span class="hljs-string">"UTF-8"</span>));
        System.out.println(<span class="hljs-string">" [x] Sent '"</span> + message + <span class="hljs-string">"'"</span>);
    }
  }
}

</code></pre>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReceiveLogs</span> </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"logs"</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    Connection connection = factory.newConnection();
    Channel channel = connection.createChannel();

    channel.exchangeDeclare(EXCHANGE_NAME, <span class="hljs-string">"fanout"</span>);
    String queueName = channel.queueDeclare().getQueue();
    channel.queueBind(queueName, EXCHANGE_NAME, <span class="hljs-string">""</span>);

    System.out.println(<span class="hljs-string">" [*] Waiting for messages. To exit press CTRL+C"</span>);

    DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {
        String message = <span class="hljs-keyword">new</span> String(delivery.getBody(), <span class="hljs-string">"UTF-8"</span>);
        System.out.println(<span class="hljs-string">" [x] Received '"</span> + message + <span class="hljs-string">"'"</span>);
    };
    channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, deliverCallback, consumerTag -&gt; { });
  }
}

</code></pre>
<h2 id="%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8Frouting">路由模式Routing <a class="header-anchor" href="#%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8Frouting">#</a></h2>
<p><img src="http://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/6548ba200d1a4e25a074cdf243fdb667" alt="image"></p>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmitLogDirect</span> </span>{

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"direct_logs"</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    <span class="hljs-keyword">try</span> (Connection connection = factory.newConnection();
         Channel channel = connection.createChannel()) {
        channel.exchangeDeclare(EXCHANGE_NAME, <span class="hljs-string">"direct"</span>);

        String severity = getSeverity(argv);
        String message = getMessage(argv);

        channel.basicPublish(EXCHANGE_NAME, severity, <span class="hljs-keyword">null</span>, message.getBytes(<span class="hljs-string">"UTF-8"</span>));
        System.out.println(<span class="hljs-string">" [x] Sent '"</span> + severity + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
    }
  }
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getSeverity</span><span class="hljs-params">(String[] strings)</span> </span>{
        <span class="hljs-keyword">if</span> (strings.length &lt; <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">"info"</span>;
        <span class="hljs-keyword">return</span> strings[<span class="hljs-number">0</span>];
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">(String[] strings)</span> </span>{
        <span class="hljs-keyword">if</span> (strings.length &lt; <span class="hljs-number">2</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello World!"</span>;
        <span class="hljs-keyword">return</span> joinStrings(strings, <span class="hljs-string">" "</span>, <span class="hljs-number">1</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">joinStrings</span><span class="hljs-params">(String[] strings, String delimiter, <span class="hljs-keyword">int</span> startIndex)</span> </span>{
        <span class="hljs-keyword">int</span> length = strings.length;
        <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        <span class="hljs-keyword">if</span> (length &lt;= startIndex) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        StringBuilder words = <span class="hljs-keyword">new</span> StringBuilder(strings[startIndex]);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = startIndex + <span class="hljs-number">1</span>; i &lt; length; i++) {
            words.append(delimiter).append(strings[i]);
        }
        <span class="hljs-keyword">return</span> words.toString();
    }
}

</code></pre>
<pre><code class="language-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReceiveLogsDirect</span> </span>{

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"direct_logs"</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    Connection connection = factory.newConnection();
    Channel channel = connection.createChannel();

    channel.exchangeDeclare(EXCHANGE_NAME, <span class="hljs-string">"direct"</span>);
    String queueName = channel.queueDeclare().getQueue();

    <span class="hljs-keyword">if</span> (argv.length &lt; <span class="hljs-number">1</span>) {
        System.err.println(<span class="hljs-string">"Usage: ReceiveLogsDirect [info] [warning] [error]"</span>);
        System.exit(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">for</span> (String severity : argv) {
        channel.queueBind(queueName, EXCHANGE_NAME, severity);
    }
    System.out.println(<span class="hljs-string">" [*] Waiting for messages. To exit press CTRL+C"</span>);

    DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {
        String message = <span class="hljs-keyword">new</span> String(delivery.getBody(), <span class="hljs-string">"UTF-8"</span>);
        System.out.println(<span class="hljs-string">" [x] Received '"</span> +
            delivery.getEnvelope().getRoutingKey() + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
    };
    channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, deliverCallback, consumerTag -&gt; { });
  }
}
</code></pre>
<h2 id="%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8Ftopics">通配符模式Topics <a class="header-anchor" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8Ftopics">#</a></h2>
<p><img src="http://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/2b79943e38774069b49cf6893437fb9c" alt="image"></p>
<p>生产者P发送消息到交换机X，type=topic，交换机根据绑定队列的routing key的值进行通配符匹配；
符号#：匹配一个或者多个词lazy.# 可以匹配lazy.irs或者lazy.irs.cor</p>
<pre><code class="language-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmitLogTopic</span> </span>{

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"topic_logs"</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    <span class="hljs-keyword">try</span> (Connection connection = factory.newConnection();
         Channel channel = connection.createChannel()) {

        channel.exchangeDeclare(EXCHANGE_NAME, <span class="hljs-string">"topic"</span>);

        String routingKey = getRouting(argv);
        String message = getMessage(argv);

        channel.basicPublish(EXCHANGE_NAME, routingKey, <span class="hljs-keyword">null</span>, message.getBytes(<span class="hljs-string">"UTF-8"</span>));
        System.out.println(<span class="hljs-string">" [x] Sent '"</span> + routingKey + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
    }
  }
   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getRouting</span><span class="hljs-params">(String[] strings)</span> </span>{
        <span class="hljs-keyword">if</span> (strings.length &lt; <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">"anonymous.info"</span>;
        <span class="hljs-keyword">return</span> strings[<span class="hljs-number">0</span>];
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">(String[] strings)</span> </span>{
        <span class="hljs-keyword">if</span> (strings.length &lt; <span class="hljs-number">2</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello World!"</span>;
        <span class="hljs-keyword">return</span> joinStrings(strings, <span class="hljs-string">" "</span>, <span class="hljs-number">1</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">joinStrings</span><span class="hljs-params">(String[] strings, String delimiter, <span class="hljs-keyword">int</span> startIndex)</span> </span>{
        <span class="hljs-keyword">int</span> length = strings.length;
        <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        <span class="hljs-keyword">if</span> (length &lt; startIndex) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        StringBuilder words = <span class="hljs-keyword">new</span> StringBuilder(strings[startIndex]);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = startIndex + <span class="hljs-number">1</span>; i &lt; length; i++) {
            words.append(delimiter).append(strings[i]);
        }
        <span class="hljs-keyword">return</span> words.toString();
    }
}

</code></pre>
<pre><code class="language-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReceiveLogsTopic</span> </span>{

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"topic_logs"</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
    factory.setHost(<span class="hljs-string">"localhost"</span>);
    Connection connection = factory.newConnection();
    Channel channel = connection.createChannel();

    channel.exchangeDeclare(EXCHANGE_NAME, <span class="hljs-string">"topic"</span>);
    String queueName = channel.queueDeclare().getQueue();

    <span class="hljs-keyword">if</span> (argv.length &lt; <span class="hljs-number">1</span>) {
        System.err.println(<span class="hljs-string">"Usage: ReceiveLogsTopic [binding_key]..."</span>);
        System.exit(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">for</span> (String bindingKey : argv) {
        channel.queueBind(queueName, EXCHANGE_NAME, bindingKey);
    }

    System.out.println(<span class="hljs-string">" [*] Waiting for messages. To exit press CTRL+C"</span>);

    DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {
        String message = <span class="hljs-keyword">new</span> String(delivery.getBody(), <span class="hljs-string">"UTF-8"</span>);
        System.out.println(<span class="hljs-string">" [x] Received '"</span> +
            delivery.getEnvelope().getRoutingKey() + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
    };
    channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, deliverCallback, consumerTag -&gt; { });
  }
}

</code></pre>
<h2 id="rpc">RPC <a class="header-anchor" href="#rpc">#</a></h2>
<p><img src="http://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/5f96e1ef416148e98a833ed10de4be44" alt="image"></p>
<pre><code class="language-java">


<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RPCServer</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String RPC_QUEUE_NAME = <span class="hljs-string">"rpc_queue"</span>;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">fib</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>{
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">return</span> fib(n - <span class="hljs-number">1</span>) + fib(n - <span class="hljs-number">2</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"localhost"</span>);

        <span class="hljs-keyword">try</span> (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            channel.queueDeclare(RPC_QUEUE_NAME, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);
            channel.queuePurge(RPC_QUEUE_NAME);

            channel.basicQos(<span class="hljs-number">1</span>);

            System.out.println(<span class="hljs-string">" [x] Awaiting RPC requests"</span>);

            Object monitor = <span class="hljs-keyword">new</span> Object();
            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {
                AMQP.BasicProperties replyProps = <span class="hljs-keyword">new</span> AMQP.BasicProperties
                        .Builder()
                        .correlationId(delivery.getProperties().getCorrelationId())
                        .build();

                String response = <span class="hljs-string">""</span>;

                <span class="hljs-keyword">try</span> {
                    String message = <span class="hljs-keyword">new</span> String(delivery.getBody(), <span class="hljs-string">"UTF-8"</span>);
                    <span class="hljs-keyword">int</span> n = Integer.parseInt(message);

                    System.out.println(<span class="hljs-string">" [.] fib("</span> + message + <span class="hljs-string">")"</span>);
                    response += fib(n);
                } <span class="hljs-keyword">catch</span> (RuntimeException e) {
                    System.out.println(<span class="hljs-string">" [.] "</span> + e.toString());
                } <span class="hljs-keyword">finally</span> {
                    channel.basicPublish(<span class="hljs-string">""</span>, delivery.getProperties().getReplyTo(), replyProps, response.getBytes(<span class="hljs-string">"UTF-8"</span>));
                    channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="hljs-keyword">false</span>);
                    <span class="hljs-comment">// RabbitMq consumer worker thread notifies the RPC server owner thread</span>
                    <span class="hljs-keyword">synchronized</span> (monitor) {
                        monitor.notify();
                    }
                }
            };

            channel.basicConsume(RPC_QUEUE_NAME, <span class="hljs-keyword">false</span>, deliverCallback, (consumerTag -&gt; { }));
            <span class="hljs-comment">// Wait and be prepared to consume the message from RPC client.</span>
            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
                <span class="hljs-keyword">synchronized</span> (monitor) {
                    <span class="hljs-keyword">try</span> {
                        monitor.wait();
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        }
    }
}

</code></pre>
<pre><code class="language-java">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RPCClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AutoCloseable</span> </span>{

    <span class="hljs-keyword">private</span> Connection connection;
    <span class="hljs-keyword">private</span> Channel channel;
    <span class="hljs-keyword">private</span> String requestQueueName = <span class="hljs-string">"rpc_queue"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RPCClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>{
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"localhost"</span>);

        connection = factory.newConnection();
        channel = connection.createChannel();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> </span>{
        <span class="hljs-keyword">try</span> (RPCClient fibonacciRpc = <span class="hljs-keyword">new</span> RPCClient()) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {
                String i_str = Integer.toString(i);
                System.out.println(<span class="hljs-string">" [x] Requesting fib("</span> + i_str + <span class="hljs-string">")"</span>);
                String response = fibonacciRpc.call(i_str);
                System.out.println(<span class="hljs-string">" [.] Got '"</span> + response + <span class="hljs-string">"'"</span>);
            }
        } <span class="hljs-keyword">catch</span> (IOException | TimeoutException | InterruptedException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">call</span><span class="hljs-params">(String message)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException </span>{
        <span class="hljs-keyword">final</span> String corrId = UUID.randomUUID().toString();

        String replyQueueName = channel.queueDeclare().getQueue();
        AMQP.BasicProperties props = <span class="hljs-keyword">new</span> AMQP.BasicProperties
                .Builder()
                .correlationId(corrId)
                .replyTo(replyQueueName)
                .build();

        channel.basicPublish(<span class="hljs-string">""</span>, requestQueueName, props, message.getBytes(<span class="hljs-string">"UTF-8"</span>));

        <span class="hljs-keyword">final</span> BlockingQueue&lt;String&gt; response = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">1</span>);

        String ctag = channel.basicConsume(replyQueueName, <span class="hljs-keyword">true</span>, (consumerTag, delivery) -&gt; {
            <span class="hljs-keyword">if</span> (delivery.getProperties().getCorrelationId().equals(corrId)) {
                response.offer(<span class="hljs-keyword">new</span> String(delivery.getBody(), <span class="hljs-string">"UTF-8"</span>));
            }
        }, consumerTag -&gt; {
        });

        String result = response.take();
        channel.basicCancel(ctag);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{
        connection.close();
    }
}

</code></pre>
<h2 id="%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%E4%BA%A4%E6%8D%A2%E5%99%A8-fanout%2Cdirect%2Ctopic">三种类型交换器 Fanout,Direct,Topic <a class="header-anchor" href="#%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%E4%BA%A4%E6%8D%A2%E5%99%A8-fanout%2Cdirect%2Ctopic">#</a></h2>
<p>fanout：不处理路由键。你只需要简单的将队列绑定到交换机上。一个发送到交换机的消息都会被转发到与该交换机绑定的所有队列上。很像子网广播，每台子网内的主机都获得了一份复制的消息。Fanout交换机转发消息是最快的。</p>
<p>direct：处理路由键。需要将一个队列绑定到交换机上，要求该消息与一个特定的路由键完全匹配。这是一个完整的匹配。如果一个队列绑定到该交换机上要求路由键 “test”，则只有被标记为“test”的消息才被转发，不会转发test.aaa，也不会转发dog.123，只会转发test。</p>
<p>topic：将路由键和某模式进行匹配。此时队列需要绑定要一个模式上。符号“#”匹配一个或多个词，符号“<em>”匹配不多不少一个词。因此“audit.#”能够匹配到“audit.irs.corporate”，但是“audit.</em>” 只会匹配到“audit.irs”。</p>
<p><img src="https://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/blog/qrcode_for_gh_55da400f21ce_344.jpg" style="width:200px;height:200px;margin-left:100px"></img></p>
<div style="margin-left:50px;color:red;font-size:32px">关注公众号，精彩继续</div></div></section><footer class="footer-container"><div class="footer-body"><div class="cols-container"><div class="col col-12"><h3>码农阿华</h3><p>联系邮箱：alfredhua@aliyun.com</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/demo1.html" target="_self">概览</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd></dl></div></div><div class="copyright"><span>CopyRight©2019 版权所有 码农阿华 京ICP备19044364号</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>