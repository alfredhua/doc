<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="3.手写mybatis" />
	<meta name="description" content="3.手写mybatis" />
	<!-- 网页标签标题 -->
	<title>3.手写mybatis</title>
	<link rel="shortcut icon" href="/img/docsite.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a class="logo" href="/zh-cn/index.html"><span class="logo-normal">码农阿华| <span class="logo-desc">玩玩技术，说说产品</span></span></a><div class="search search-normal"><span class="icon-search"></span></div><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/docs/begin.html" target="_self">文档</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/blog/index.html" target="_self">博客</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>设计模式</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>设计原则<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/2.开闭原则.html" target="_self">开闭原则</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/3.接口隔离原则.html" target="_self">接口隔离原则</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/1.设计模式/1.单一职责.html" target="_self">单一职责</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>JAVA</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>目录<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/dir/demo3.html" target="_self">示例3</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h2 id="mybatis%E4%B8%AD%E7%9A%84%E5%85%B3%E9%94%AE%E7%B1%BB">Mybatis中的关键类 <a class="header-anchor" href="#mybatis%E4%B8%AD%E7%9A%84%E5%85%B3%E9%94%AE%E7%B1%BB">#</a></h2>
<ul>
<li>入口: SqlSessionFactoryBuild().build().openSqlSession().getMapper(BlogMapper.class);</li>
</ul>
<pre><code class="language-java"><span class="hljs-keyword">package</span> com.hbatis.v2.session;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionFactoryBuild</span> </span>{

  <span class="hljs-keyword">private</span> Configuration configuration;
  
  <span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactoryBuild <span class="hljs-title">build</span><span class="hljs-params">()</span> </span>{
    configuration=<span class="hljs-keyword">new</span> Configuration();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
  <span class="hljs-function"><span class="hljs-keyword">public</span> DefaultSqlSession <span class="hljs-title">openSqlSession</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSqlSession(configuration);
  }
}

</code></pre>
<ul>
<li>定义DefaultSqlSession</li>
</ul>
<pre><code class="language-java"><span class="hljs-keyword">package</span> com.hbatis.v2.session;

<span class="hljs-keyword">import</span> com.hbatis.v2.executor.Executor;
<span class="hljs-keyword">import</span> com.hbatis.v2.mapper.BlogMapper;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultSqlSession</span> </span>{

  <span class="hljs-keyword">private</span> Configuration configuration;

  <span class="hljs-keyword">private</span> Executor executor;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultSqlSession</span><span class="hljs-params">(Configuration configuration)</span> </span>{

    <span class="hljs-keyword">this</span>.configuration = configuration;
    <span class="hljs-keyword">this</span>.executor=configuration.newExecutor();

  }
  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getMapper</span><span class="hljs-params">(Class clazz)</span> </span>{
    <span class="hljs-keyword">return</span> configuration.getMapper(clazz,<span class="hljs-keyword">this</span>);
  }

}
</code></pre>
<ul>
<li>配置config，这个扫描指定路径，加载XML文件，这里用key--value的properties来代替处理。</li>
</ul>
<pre><code class="language-java"><span class="hljs-keyword">package</span> com.hbatis.v2.session;

<span class="hljs-keyword">import</span> com.hbatis.v2.binding.MapperRegistry;
<span class="hljs-keyword">import</span> com.hbatis.v2.executor.Executor;
<span class="hljs-keyword">import</span> com.hbatis.v2.executor.SimpleExecutor;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Configuration</span> </span>{

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ResourceBundle sqlMappings; <span class="hljs-comment">// SQL映射关系配置，使用注解时不用重复配置</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ResourceBundle properties; <span class="hljs-comment">// 全局配置</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> MapperRegistry MAPPER_REGISTRY = <span class="hljs-keyword">new</span> MapperRegistry(); <span class="hljs-comment">// 维护接口与工厂类关系</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; mappedStatements = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
  <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; mapperList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(); <span class="hljs-comment">// 所有Mapper接口</span>
  <span class="hljs-keyword">private</span> List&lt;String&gt; classPaths = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(); <span class="hljs-comment">// 类所有文件</span>

  <span class="hljs-keyword">static</span> {
    sqlMappings=ResourceBundle.getBundle(<span class="hljs-string">"sql"</span>);
    properties=ResourceBundle.getBundle(<span class="hljs-string">"mybatis"</span>);

  }


  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Configuration</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// 1.解析sql.properties</span>
    <span class="hljs-keyword">for</span> (String key:sqlMappings.keySet()) {
      Class mapper=<span class="hljs-keyword">null</span>;
      Class pojo=<span class="hljs-keyword">null</span>;
      String statement= sqlMappings.getString(key).split(<span class="hljs-string">"--"</span>)[<span class="hljs-number">0</span>];
      String pojoStr = sqlMappings.getString(key).split(<span class="hljs-string">"--"</span>)[<span class="hljs-number">1</span>];

      <span class="hljs-keyword">try</span> {

        Class.forName(key.substring(<span class="hljs-number">0</span>, key.lastIndexOf(<span class="hljs-string">"."</span>)));
        pojo=Class.forName(pojoStr);

      }<span class="hljs-keyword">catch</span> (Exception e){
        e.printStackTrace();
      }

      MAPPER_REGISTRY.addMapper(mapper,pojo);
      mappedStatements.put(key,statement);

    }
    String mapperPath = properties.getString(<span class="hljs-string">"mapper.path"</span>);
    scanPackage(mapperPath);
  }

  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scanPackage</span><span class="hljs-params">(String mapperPath)</span> </span>{
    String classPath = <span class="hljs-keyword">this</span>.getClass().getResource(<span class="hljs-string">"/"</span>).getPath();
    mapperPath = mapperPath.replace(<span class="hljs-string">"."</span>, File.separator);
    String mainPath = classPath + mapperPath;
    doPath(<span class="hljs-keyword">new</span> File(mainPath));
    <span class="hljs-keyword">for</span> (String className : classPaths) {
      className = className.replace(classPath.replace(<span class="hljs-string">"/"</span>,<span class="hljs-string">"\\"</span>).replaceFirst(<span class="hljs-string">"\\\\"</span>,<span class="hljs-string">""</span>),<span class="hljs-string">""</span>).replace(<span class="hljs-string">"\\"</span>,<span class="hljs-string">"."</span>).replace(<span class="hljs-string">".class"</span>,<span class="hljs-string">""</span>);
      Class&lt;?&gt; clazz = <span class="hljs-keyword">null</span>;
      <span class="hljs-keyword">try</span> {
        clazz = Class.forName(className);
      } <span class="hljs-keyword">catch</span> (ClassNotFoundException e) {
        e.printStackTrace();
      }
      <span class="hljs-keyword">if</span>(clazz.isInterface()){
        mapperList.add(clazz);
      }

    }

  }

  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPath</span><span class="hljs-params">(File file)</span> </span>{
    <span class="hljs-keyword">if</span>(file.isDirectory()){
      File[] files = file.listFiles();
      <span class="hljs-keyword">for</span> (File f1:files) {
        doPath(f1);
      }
    }<span class="hljs-keyword">else</span>{
      <span class="hljs-keyword">if</span>(file.getName().endsWith(<span class="hljs-string">".class"</span>)){
        classPaths.add(file.getPath());
      }
    }
  }


  <span class="hljs-function"><span class="hljs-keyword">public</span> Executor <span class="hljs-title">newExecutor</span><span class="hljs-params">()</span> </span>{
    Executor executor=<span class="hljs-keyword">null</span>;
    <span class="hljs-comment">//    if(properties.getString("cache.enabled").equals("true")){</span>

    <span class="hljs-comment">//    }else{</span>
    executor=<span class="hljs-keyword">new</span> SimpleExecutor();
    <span class="hljs-comment">//    }</span>
    <span class="hljs-keyword">return</span> executor;
  }


  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getMapper</span><span class="hljs-params">(Class clazz, DefaultSqlSession sqlSession)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  }

}

</code></pre>
<ul>
<li>所有的代理类存储的器，Map的形式</li>
</ul>
<pre><code class="language-java"><span class="hljs-keyword">package</span> com.hbatis.v2.binding;

<span class="hljs-keyword">import</span> com.hbatis.v2.session.DefaultSqlSession;

<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapperRegistry</span> </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;,MapperProxyFactory&gt; knownMappers =<span class="hljs-keyword">new</span> HashMap&lt;&gt;();


  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addMapper</span><span class="hljs-params">(Class&lt;T&gt; clazz,Class pojo)</span></span>{
    knownMappers.put(clazz,<span class="hljs-keyword">new</span> MapperProxyFactory());
  }

  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getMapper</span><span class="hljs-params">(Class&lt;T&gt; clazz, DefaultSqlSession sqlSession)</span></span>{
    MapperProxyFactory mapperProxyFactory = knownMappers.get(clazz);
    <span class="hljs-keyword">return</span> (T)mapperProxyFactory.newInstance(sqlSession);
  }

}

</code></pre>
<ul>
<li>测试类</li>
</ul>
<pre><code class="language-java">
<span class="hljs-keyword">package</span> com.hbatis.v2;

<span class="hljs-keyword">import</span> com.hbatis.v2.mapper.Blog;
<span class="hljs-keyword">import</span> com.hbatis.v2.mapper.BlogMapper;
<span class="hljs-keyword">import</span> com.hbatis.v2.session.SqlSessionFactoryBuild;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestHbatis</span> </span>{

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
    BlogMapper mapper = <span class="hljs-keyword">new</span> SqlSessionFactoryBuild().build().openSqlSession().getMapper(BlogMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Blog blog = mapper.selectBlogById(<span class="hljs-number">1</span>);
    System.out.println(blog);
  }

}
</code></pre>
<p>github地址：<a href="https://github.com/alfredhua/test/tree/master/Hbatis">https://github.com/alfredhua/test/tree/master/Hbatis</a></p>
</div></section><footer class="footer-container"><div class="footer-body"><div class="cols-container"><div class="col col-12"><h3>码农阿华</h3><p>联系邮箱：alfredhua@aliyun.com</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/demo1.html" target="_self">概览</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd></dl></div></div><div class="copyright"><span>CopyRight©2019 版权所有 码农阿华 京ICP备19044364号</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>